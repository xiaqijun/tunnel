# 一键部署到服务器指南

## 🚀 最简单的部署方式（推荐）

### 方法 1：一条命令完成（最快）⭐

SSH 连接到服务器后，执行：

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/xiaqijun/tunnel/main/deploy-to-server.sh)
```

或者如果 curl 不可用：

```bash
bash <(wget -qO- https://raw.githubusercontent.com/xiaqijun/tunnel/main/deploy-to-server.sh)
```

**就这样！** 脚本会自动：
- ✅ 检测 GitHub Actions 构建状态
- ✅ 等待构建完成（如果正在构建）
- ✅ 下载预编译二进制文件
- ✅ 配置防火墙
- ✅ 生成随机 Token
- ✅ 启动服务

---

## 📋 分步部署（更可控）

### 步骤 1：连接到服务器

```bash
ssh root@47.243.104.165
```

### 步骤 2：下载部署脚本

```bash
wget https://raw.githubusercontent.com/xiaqijun/tunnel/main/deploy-to-server.sh
chmod +x deploy-to-server.sh
```

### 步骤 3：执行部署

```bash
./deploy-to-server.sh
```

---

## 🔍 脚本功能

智能部署脚本会：

1. **检测系统架构** - 自动识别 AMD64/ARM64
2. **检查构建状态** - 验证 GitHub Release 是否就绪
3. **等待构建完成** - 如果正在构建，自动等待（最多5分钟）
4. **下载二进制文件** - 从 GitHub Releases 下载预编译版本
5. **安装到系统** - 安装到 /opt/tunnel
6. **生成配置文件** - 自动生成安全的随机 Token
7. **配置防火墙** - 自动开放 7000 和 8080 端口
8. **安装系统服务** - 配置 systemd 服务并设置开机自启
9. **显示信息** - 显示 Token 和访问地址

---

## ⏱️ 预计时间

- 如果 GitHub 构建已完成：**30 秒**
- 如果正在构建：**2-5 分钟**（自动等待）

---

## ✅ 部署后验证

### 1. 检查服务状态

```bash
systemctl status tunnel-server
```

应该看到：`Active: active (running)`

### 2. 查看日志

```bash
journalctl -u tunnel-server -f
```

### 3. 测试端口

```bash
netstat -tlnp | grep -E '7000|8080'
```

应该看到两个端口都在监听。

### 4. 访问 Web 界面

浏览器打开：**http://47.243.104.165:8080**

---

## 🔐 获取 Token

部署完成后，Token 会显示在屏幕上，同时保存在：

```bash
cat /opt/tunnel/.token
```

或从配置文件获取：

```bash
grep token /opt/tunnel/config.yaml
```

---

## 💻 客户端连接

### Windows 客户端

1. 下载：https://github.com/xiaqijun/tunnel/releases/tag/v1.0.0
2. 下载 `tunnel-windows-amd64.zip`
3. 解压后编辑 `client-config.yaml`：

```yaml
server:
  addr: "47.243.104.165:7000"
  token: "YOUR-TOKEN-HERE"  # 使用服务器的 Token

client:
  name: "my-pc"

tunnels:
  - name: "local-web"
    local_addr: "127.0.0.1"
    local_port: 8080
    remote_port: 8000
```

4. 运行：

```cmd
tunnel-client-windows-amd64.exe -config client-config.yaml
```

5. 访问：`http://47.243.104.165:8000` 即可访问本地 8080 端口

---

## 🛠️ 常用命令

```bash
# 启动服务
systemctl start tunnel-server

# 停止服务
systemctl stop tunnel-server

# 重启服务
systemctl restart tunnel-server

# 查看状态
systemctl status tunnel-server

# 查看日志
journalctl -u tunnel-server -f

# 查看最近 50 行日志
journalctl -u tunnel-server -n 50

# 重新生成 Token
RANDOM_TOKEN=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)
sed -i "s/token:.*/token: \"$RANDOM_TOKEN\"/" /opt/tunnel/config.yaml
systemctl restart tunnel-server
echo "新 Token: $RANDOM_TOKEN"
```

---

## 🔄 更新版本

```bash
# 下载最新部署脚本
wget https://raw.githubusercontent.com/xiaqijun/tunnel/main/deploy-to-server.sh -O deploy-to-server.sh
chmod +x deploy-to-server.sh

# 执行更新（会保留配置文件）
./deploy-to-server.sh
```

---

## ❓ 故障排查

### 无法访问 Web 界面

```bash
# 检查服务
systemctl status tunnel-server

# 检查端口
netstat -tlnp | grep 8080

# 检查日志
journalctl -u tunnel-server -n 50

# 检查防火墙
iptables -L -n | grep 8080

# 如果使用云服务器，需要在控制台开放安全组
```

### 客户端无法连接

```bash
# 检查 7000 端口
netstat -tlnp | grep 7000

# 检查服务日志
journalctl -u tunnel-server -f

# 验证 Token 是否正确
grep token /opt/tunnel/config.yaml
```

### 卸载服务

```bash
# 停止服务
systemctl stop tunnel-server
systemctl disable tunnel-server

# 删除服务文件
rm /etc/systemd/system/tunnel-server.service
systemctl daemon-reload

# 删除程序文件（可选）
rm -rf /opt/tunnel
```

---

## 📞 需要帮助？

- **项目文档**：https://github.com/xiaqijun/tunnel
- **查看 Actions**：https://github.com/xiaqijun/tunnel/actions
- **下载 Releases**：https://github.com/xiaqijun/tunnel/releases

---

## 🎉 快速开始

```bash
# 最简单的方式 - 一条命令搞定！
ssh root@47.243.104.165
bash <(wget -qO- https://raw.githubusercontent.com/xiaqijun/tunnel/main/deploy-to-server.sh)
```

就是这么简单！🚀
