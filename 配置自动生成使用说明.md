# 配置自动生成使用说明

## 功能说明

服务器现在可以自动生成客户端配置文件，客户端无需手动创建 `client-config.yaml`。

## 新增 API 端点

### 1. 下载配置文件（YAML格式）

```bash
GET /api/download/config?name=客户端名称
```

**参数：**
- `name`（可选）：客户端名称，默认为 `my-client`

**返回：** YAML 格式的配置文件

**示例：**
```bash
curl -fsSL "http://47.243.104.165:8080/api/download/config?name=my-laptop" -o client-config.yaml
```

### 2. 生成配置预览（JSON格式）

```bash
GET /api/config/generate?name=客户端名称
```

**参数：**
- `name`（可选）：客户端名称，默认为 `my-client`

**返回：** JSON 格式的配置对象

**示例：**
```bash
curl "http://47.243.104.165:8080/api/config/generate?name=test-client"
```

## 一键部署命令

### Linux

```bash
# 使用 curl
curl -fsSL "http://47.243.104.165:8080/api/download/config?name=my-linux" -o client-config.yaml && \
curl -fsSL http://47.243.104.165:8080/api/download/client/linux/amd64 -o tunnel-client && \
chmod +x tunnel-client && \
./tunnel-client -config client-config.yaml

# 使用 wget
wget "http://47.243.104.165:8080/api/download/config?name=my-linux" -O client-config.yaml && \
wget http://47.243.104.165:8080/api/download/client/linux/amd64 -O tunnel-client && \
chmod +x tunnel-client && \
./tunnel-client -config client-config.yaml
```

### Windows

```powershell
# PowerShell
irm http://47.243.104.165:8080/api/download/config?name=my-pc -OutFile client-config.yaml
irm http://47.243.104.165:8080/api/download/client/windows/amd64 -OutFile tunnel-client.exe
.\tunnel-client.exe -config client-config.yaml

# CMD
curl -o client-config.yaml "http://47.243.104.165:8080/api/download/config?name=my-pc"
curl -o tunnel-client.exe http://47.243.104.165:8080/api/download/client/windows/amd64
tunnel-client.exe -config client-config.yaml
```

### macOS

```bash
curl -fsSL "http://47.243.104.165:8080/api/download/config?name=my-mac" -o client-config.yaml && \
curl -fsSL http://47.243.104.165:8080/api/download/client/darwin/amd64 -o tunnel-client && \
chmod +x tunnel-client && \
./tunnel-client -config client-config.yaml
```

## 配置文件说明

自动生成的配置文件包含：

```yaml
# Tunnel 客户端配置
# 由服务器自动生成

server:
  addr: "47.243.104.165:7000"  # 自动填充服务器地址
  token: "your-token"           # 自动填充认证令牌

client:
  name: "my-client"             # 您指定的客户端名称
  reconnect_interval: 5         # 重连间隔（秒）
  heartbeat_interval: 30        # 心跳间隔（秒）

tunnels:
  - name: "web"                 # 默认Web隧道
    local_addr: "127.0.0.1"
    local_port: 8080
    remote_port: 8000
  
  # 添加更多隧道（可选）
  # - name: "ssh"
  #   local_addr: "127.0.0.1"
  #   local_port: 22
  #   remote_port: 2222
```

## 工作原理

1. **IP地址检测**：服务器自动检测正确的IP地址
   - 优先使用配置文件中的 `bind_addr`（如果不是 `0.0.0.0`）
   - 其次检查 `X-Real-IP` 请求头（反向代理）
   - 再次检查 `X-Forwarded-For` 请求头
   - 最后使用请求的 `Host` 头

2. **Token自动填充**：从服务器配置中读取认证令牌

3. **端口自动填充**：使用服务器的隧道端口（默认7000）

## 优势

- ✅ **零配置**：客户端无需手动创建配置文件
- ✅ **防错误**：避免IP、端口、Token等配置错误
- ✅ **一键部署**：下载配置和客户端后立即可用
- ✅ **灵活命名**：通过URL参数自定义客户端名称
- ✅ **快速测试**：快速在多台机器上部署测试

## 下一步

1. 等待 GitHub Actions 构建完成（v1.0.1）
2. 部署到服务器：
   ```bash
   ssh root@47.243.104.165
   wget https://github.com/xiaqijun/tunnel/releases/download/v1.0.1/tunnel-v1.0.1-linux-amd64.tar.gz
   tar -xzf tunnel-v1.0.1-linux-amd64.tar.gz
   systemctl stop tunnel-server
   mv tunnel-server /usr/local/bin/
   systemctl start tunnel-server
   ```

3. 测试配置生成：
   ```bash
   curl "http://47.243.104.165:8080/api/config/generate?name=test"
   ```

4. 测试客户端安装：
   ```bash
   curl -fsSL "http://47.243.104.165:8080/api/download/config?name=test-client" -o client-config.yaml && \
   curl -fsSL http://47.243.104.165:8080/api/download/client/linux/amd64 -o tunnel-client && \
   chmod +x tunnel-client && \
   ./tunnel-client -config client-config.yaml
   ```
